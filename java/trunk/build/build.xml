<?xml version="1.0" encoding="UTF-8"?>
<project basedir=".." default="build-src" name="macchiato-doppio">
	<property name="src" value="${basedir}/src"/>
	<property name="bin" value="${basedir}/bin"/>
	<property name="docs" value="${basedir}/doc"/>
	<property name="dist" value="${basedir}/dist"/>
	
	<target name="get-revision">
		<exec executable="svn">
			<arg value="stat"/>
			<arg value="-u"/>
			<redirector outputproperty="revision">
				<outputfilterchain>
					<replaceregex pattern="(^.*Status\sagainst\srevision\p{Punct}\s*|^.*\w$)" replace="" flags="sig"/>
				</outputfilterchain>
			</redirector>
		</exec>
		
		<echo message="revision ${revision}"/>
	</target>
	
	<target name="build-src">
		<javac srcdir="${src}" destdir="${bin}" debug="on" includes="org/**" excludes="test/**"/>
	</target>
	
	<target name="build-test">
		<javac srcdir="${src}" destdir="${bin}" debug="on" includes="test/**" excludes="org/**"/>
	</target>
	
	<target name="generate-api">
		<javadoc	packagenames="org.*"
					sourcepath="${src}"
					destdir="${docs}/api"
					author="true"
					version="true"
					use="true"
					windowtitle="Macchiatto Doppio API"
					linksource="yes"
		>
			<doctitle><![CDATA[<h1>Macchiato Doppio API</h1>]]></doctitle>
			<bottom><![CDATA[<i>Copyright &#169; 2003 Matthew Stockbridge. All Rights Reserved.</i>]]></bottom>
			<group title="Control Framework" packages="org.control.*"/>
			<group title="Display Framework" packages="org.display.*"/>
			<group title="Logic Framework" packages="org.interaction.*"/>
			<group title="Object Model" packages="org.model.*"/>
			<link href="http://java.sun.com./javase/6/docs/api/"/>
		</javadoc>
	</target>
	
	<target name="make-jar" depends="get-revision,build-src">
		<tstamp/>
		<jar destfile="${dist}/MDJ.jar" basedir="${bin}" excludes="test/**" update="true">
			<manifest>
				<attribute name="Built-By" value="${user.name}"/>
				<section name="org">
					<attribute name="Manifest-Version" value="1.0"/>
					<attribute name="Implementation-Vendor" value="Matt Stockbridge"/>
					<attribute name="Implementation-Title" value="org"/>
					<attribute name="Implementation-Version" value="revision ${revision}, ${TODAY}"/>
					<attribute name="Specification-Vendor" value="Matt Stockbridge"/>
					<attribute name="Specification-Version" value="0.1alpha"/>
					<attribute name="Specification-Title" value="MDJ Core"/>
				</section>
			</manifest>
		</jar>
	</target>
</project>